<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
  </head>
  <body>
    <script>
      let Publish = function(name) {
        this.name = name;
        this.subscribers = []; // 数组中存储所有的订阅者，数组的元素都是函数类型
      };
      // Publish 的实例对象方法 发布消息
      Publish.prototype.deliver = function(news) {
        let publish = this; // this 代表报社
        this.subscribers.forEach(function(item) {
          // 循环 subscribers 中的所有订报人，为这些人发布内容
          item(news, publish); // 每个订阅者都收到了新闻（news），还有来自哪家报刊
        });
        return this; // 链式调用
      };

      // 观察者（订阅者）
      // 订阅者的方法,每一个订阅者都是一个函数,在函数原型上扩展一个方法
      Function.prototype.subscribe = function(publish) {
        console.log(publish);
        //出版社形参
        let sub = this; // 取得当前订阅者这个人
        // 不能同时订一家出版社同一份报纸,没意义
        // publish.subscribers 张三，李四，王五，名字可能重复
        // publish.subscribers 数组里面有的人，不能再订阅
        // 我们使用ES6里面的some方法，循环遍历数组的每一个元素，执行一个函数，如果有相同的名字则返回true，不相同则返回false
        let alreadExists = publish.subscribers.some(function(item) {
          return item === sub;
        });
        // 如果出版社名单没有这个人，则加入其中
        if (!alreadExists) {
          publish.subscribers.push(sub);
        }
        return this; // 链式调用。
      };

      // 取消订阅
      //具体的一个订阅者去取消订阅报纸的方法
      Function.prototype.unsubscribe = function(publish) {
        let sub = this; //取得当前订阅者这个人
        // filter (过滤函数:循环便利数组的每一个元素，执行一个函数如果不匹配，则删除该元素)
        publish.subscribers = publish.subscribers.filter(function(item) {
          return item !== sub;
        });
        return this; //为了方便，采用链式调用。
      };

      //实例化发布者对象(报社对象)
      let pub1 = new Publish("报社一");
      let pub2 = new Publish("报社二");
      let pub3 = new Publish("报社三");

      //观察者
      let sub1 = function(news, pub) {
        console.log(pub.name + "====sub1===" + news);
      };
      let sub2 = function(news, pub) {
        console.log(pub.name + "====sub2===" + news);
      };
      //执行订阅方法
      sub1
        .subscribe(pub1)
        .subscribe(pub2)
        .subscribe(pub3);
      sub2
        .subscribe(pub1)
        .subscribe(pub2)
        .subscribe(pub3);

      pub1.deliver(343434, pub1);
      pub2.deliver(4444444444, pub2);
      pub3.deliver(656, pub3);
      sub1.unsubscribe(pub1); //取消订阅
      pub2.deliver(4444444444, pub2);
    </script>
  </body>
</html>
